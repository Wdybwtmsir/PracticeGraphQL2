@page "/PassengerDetails/{id:int}"
@using PracticeGraphQLClient2.DataAccess
@using PracticeGraphQLClient2.DataAccess.Model
@inject NavigationManager NavigationManager

<h3>👤 Детали пассажира</h3>

@if (passenger == null)
{
    <div class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5>Личная информация</h5>
                </div>
                <div class="card-body">
                    <p><strong>ID:</strong> @passenger.PassengerId</p>
                    <p><strong>ФИО:</strong> @passenger.LastName @passenger.FirstName @passenger.SurName</p>
                    <p><strong>Email:</strong> @passenger.Email</p>
                    <p><strong>Телефон:</strong> @passenger.Phone</p>
                    <p><strong>Возраст:</strong> @passenger.Age</p>
                    <p><strong>Адрес:</strong> @passenger.Address</p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5>Статистика поездок</h5>
                </div>
                <div class="card-body">
                    <p><strong>Всего билетов:</strong> @ticketCount</p>
                    <p><strong>На сумму:</strong> @totalSpent.ToString("C")</p>
                </div>
            </div>
        </div>
    </div>

    @if (movements != null && movements.Any())
    {
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5>История поездок</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Поезд</th>
                            <th>Маршрут</th>
                            <th>Дата</th>
                            <th>Цена</th>
                            <th>Продавец</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var move in movements)
                        {
                            <tr>
                                <td>@move.TrainName (@move.TrainNumber)</td>
                                <td>@move.DepartureStation → @move.ArrivalStation</td>
                                <td>@move.PurchaseDate.ToShortDateString()</td>
                                <td>@move.TicketPrice.ToString("C")</td>
                                <td>@move.SellerName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <div class="mt-3">
        <button class="btn btn-secondary" @onclick="GoBack">← Назад</button>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private Passenger? passenger;
    private List<PassengerMovement>? movements;
    private int ticketCount;
    private decimal totalSpent;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            passenger = await Query.GetPassengerById(Id);
            movements = await Query.GetPassengerMovements(Id);

            if (movements != null)
            {
                ticketCount = movements.Count;
                totalSpent = movements.Sum(m => m.TicketPrice);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки: {ex.Message}");
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/Passengers");
    }
}